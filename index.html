<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosmoNews - Mapa Estelar Interativo</title>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.0/astronomy-engine.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        html, body {
            height: 100%; /* Garante que HTML e Body ocupem a altura total da viewport */
            margin: 0;
            padding: 0;
            display: flex; /* Torna o body um contêiner flexível */
            flex-direction: column; /* Organiza os filhos verticalmente */
        }

        :root {
            --space-dark: #0B0D17;
            --space-blue: #1A1B41;
            --neon-blue: #4DEDFF;
            --neon-purple: #845AFF;
            --star-yellow: #FFE66D;
            --news-red: #FF4D4D;
            --day-bg: #f0f8ff;
            --day-text: #333;
            --day-card: #ffffff;
            --day-border: #d0e8ff;
        }
        
        /* Modo dia/noite */
        body.day-mode {
            background-color: var(--day-bg);
            color: var(--day-text);
            background-image: none; /* Remove o gradiente no modo dia */
        }
        
        body.day-mode .map-container, 
        body.day-mode .stellar-clock,
        body.day-mode .info-box,
        body.day-mode .country-details-panel, /* Adicionado para o novo painel */
        body.day-mode .controls {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--day-border);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        body.day-mode .country-details-panel .news-section { /* Estilo específico para notícias no painel de detalhes */
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid var(--day-border);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }
        
        body.day-mode .info-title, 
        body.day-mode .news-title,
        body.day-mode .info-label {
            color: #1a73e8;
        }
        
        body.day-mode .country-details-panel .news-section {
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.1);
        }
        
        body.day-mode .theme-toggle {
            background: var(--day-card);
            color: #333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--space-dark);
            color: white;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(255, 230, 109, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 30%, rgba(77, 237, 255, 0.1) 0%, transparent 25%),
                radial-gradient(circle at 50% 80%, rgba(132, 90, 255, 0.1) 0%, transparent 30%);
            transition: background-color 0.5s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
            flex-grow: 1; /* Permite que o contêiner principal ocupe o espaço restante */
            display: flex;
            flex-direction: column; /* Organiza os filhos verticalmente dentro do contêiner */
        }

        header {
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
            padding-top: 1rem;
        }

        h1 {
            font-size: 2.8rem;
            margin: 0;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 10px rgba(77, 237, 255, 0.3);
            position: relative;
            z-index: 2;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        .planet-decoration {
            position: absolute;
            border-radius: 50%;
            filter: blur(10px);
            opacity: 0.7;
            z-index: 1;
        }

        .planet-1 {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 30% 30%, var(--neon-blue), var(--space-blue));
            top: -30px;
            left: 10%;
            animation: float 8s ease-in-out infinite;
        }

        .planet-2 {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle at 30% 30%, var(--neon-purple), #3A1B6E);
            bottom: -50px;
            right: 10%;
            animation: float 10s ease-in-out infinite 2s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(26, 27, 65, 0.7);
            border: 1px solid var(--neon-blue);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(77, 237, 255, 0.2);
            transform: translateY(-2px);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            flex-grow: 1; /* Permite que o conteúdo principal ocupe o espaço restante */
        }

        .map-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative; /* Para posicionar o painel de detalhes do país */
            flex-grow: 1; /* Permite que a seção do mapa cresça */
        }

        .map-container {
            background: rgba(26, 27, 65, 0.5);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(77, 237, 255, 0.2);
            box-shadow: 0 0 20px rgba(77, 237, 255, 0.1);
            position: relative;
            flex-grow: 1; /* Permite que o contêiner do mapa ocupe o espaço disponível */
            min-height: 400px; /* Adiciona uma altura mínima para garantir visibilidade */
        }

        #world-map {
            width: 100%;
            height: 100%; /* Garante que o elemento SVG ocupe 100% da altura do seu pai */
            cursor: grab; /* Cursor para indicar que pode ser arrastado */
        }
        #world-map.grabbing {
            cursor: grabbing;
        }

        .country { /* Estilo padrão do país */
            transition: fill 0.2s ease, transform 0.1s ease-out, stroke 0.2s ease;
            transform-origin: center center; /* Garante que a escala seja do centro */
        }
        .country:hover:not(.selected) { /* Apenas para países não selecionados */
            transform: scale(1.025); /* Ajustado para 1.025 (metade do efeito anterior) */
        }
        .country.selected { /* Estilo para o país selecionado */
            fill: var(--neon-blue) !important; /* Força a cor de seleção */
            stroke: white !important;
            stroke-width: 1.5 !important;
        }
        
        /* Estilo para a caixa de informações SIMPLIFICADAS com bandeira no mapa (aparece no hover) */
        .map-country-hover-info {
            position: absolute;
            background: rgba(0, 0, 0, 0.85); /* Mais escuro para destaque */
            border: 1px solid var(--neon-blue);
            border-radius: 8px;
            padding: 8px 12px; /* Reduzido para menos conteúdo */
            pointer-events: none; /* Crucial para não bloquear interações do mapa */
            z-index: 101; /* Acima de tudo no mapa */
            display: flex;
            align-items: center; /* Alinha bandeira e nome horizontalmente */
            gap: 10px;
            opacity: 0;
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
            transform: translate(0px, -50%); /* Ajuste para centralizar verticalmente em relação ao mouse/país */
            min-width: 120px; /* Largura mínima para os detalhes */
            max-width: 200px; /* Largura máxima */
            box-shadow: 0 4px 15px rgba(77, 237, 255, 0.2);
        }

        .map-country-hover-info.show {
            opacity: 1;
            transform: translate(0px, -50%); /* Mantém a posição ajustada */
        }

        .map-country-hover-info img {
            width: 24px; /* Tamanho menor para a bandeira no hover */
            height: 18px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .map-country-hover-info span {
            font-size: 1rem; /* Tamanho da fonte ajustado */
            font-weight: bold;
            color: var(--star-yellow); /* Destaque o nome do país */
            white-space: nowrap; /* Evita quebra de linha no nome */
            overflow: hidden;
            text-overflow: ellipsis; /* Adiciona reticências se o nome for muito longo */
        }


        /* Novo painel de informações detalhadas do país (AGORA SÓ NO CLIQUE) */
        .country-details-panel {
            position: absolute; /* Posicionamento absoluto dentro de map-section */
            top: 0;
            right: -320px; /* Escondido à direita por padrão */
            width: 300px; /* Largura do painel */
            height: 100%;
            background: rgba(26, 27, 65, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(77, 237, 255, 0.3);
            box-shadow: 0 0 30px rgba(77, 237, 255, 0.2);
            z-index: 90; /* Abaixo do hover-tooltip, mas acima do mapa */
            transition: right 0.4s ease-out, opacity 0.4s ease-out; /* Animação de entrada/saída */
            opacity: 0; /* Escondido por padrão */
            pointer-events: none; /* Não interfere com cliques no mapa quando escondido */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto; /* Para conteúdo que excede a altura */
        }

        .country-details-panel.show {
            right: 0; /* Ajuste para a posição desejada quando visível */
            opacity: 1;
            pointer-events: auto; /* Permite interação quando visível */
        }
        /* Ajuste para que o painel apareça ao lado do mapa quando há espaço */
        @media (min-width: 1600px) { /* Aumentar o max-width do container para 1600px */
            .main-content {
                grid-template-columns: 1fr 300px 1fr; /* Mapa | Painel Detalhes | Info Panel */
                gap: 2rem;
            }
            .map-section {
                grid-column: 1 / 2; /* Mapa na primeira coluna */
            }
            .country-details-panel {
                position: relative; /* Torna-o parte do grid */
                right: auto;
                top: auto;
                opacity: 1; /* Sempre visível se o grid permitir */
                pointer-events: auto;
                grid-column: 2 / 3; /* Painel de detalhes na segunda coluna */
                width: auto; /* Ajusta à coluna do grid */
                height: auto;
            }
            .info-panel {
                grid-column: 3 / 4; /* Painel de informações na terceira coluna */
            }
        }
        /* Ajuste para que o painel apareça abaixo do mapa em telas menores */
        @media (max-width: 1599px) and (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr; /* Em telas menores, o mapa e o painel de detalhes ficam em uma única coluna */
            }
            .map-section {
                width: 100%; /* Ocupa toda a largura da coluna */
            }
            .country-details-panel {
                position: relative; /* Volta a ser parte do fluxo normal */
                right: auto;
                top: auto;
                width: 100%;
                height: auto;
                opacity: 1; /* Sempre visível se o grid permitir */
                pointer-events: auto;
                margin-top: 1.5rem; /* Espaço entre o mapa e o painel */
            }
        }


        .country-details-panel .flag-and-name {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .country-details-panel .flag-and-name img {
            width: 40px;
            height: 30px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }
        .country-details-panel .flag-and-name h3 {
            margin: 0;
            color: var(--neon-blue);
            font-size: 1.6rem;
        }
        .country-details-panel p {
            margin: 0.5rem 0;
        }


        .info-label {
            color: var(--neon-blue);
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 1rem;
            background: rgba(26, 27, 65, 0.5);
            border-radius: 15px;
            padding: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(77, 237, 255, 0.2);
            box-shadow: 0 0 20px rgba(77, 237, 255, 0.1);
        }

        .control-btn {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border: none;
            border-radius: 8px;
            padding: 0.8rem;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(77, 237, 255, 0.2);
            transform: translateY(-2px);
        }

        .info-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            flex-grow: 1; /* Permite que o painel de informações cresça */
        }

        .stellar-clock {
            background: rgba(26, 27, 65, 0.5);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(77, 237, 255, 0.2);
            box-shadow: 0 0 20px rgba(77, 237, 255, 0.1);
        }

        .stellar-time {
            font-size: 3rem;
            font-family: 'Courier New', monospace;
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0.5rem 0;
        }

        .stellar-date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1.2rem;
            border-left: 3px solid var(--neon-blue);
        }

        .info-title {
            color: var(--neon-blue);
            margin-top: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .planet-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }

        .planet-list li {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .planet-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Estilo para a seção de notícias DENTRO do painel de detalhes do país */
        .country-details-panel .news-section {
            background: rgba(0, 0, 0, 0.3); /* Um pouco mais escuro que o painel principal */
            border-radius: 10px;
            padding: 1.2rem;
            border-left: 3px solid var(--news-red);
            margin-top: 1.5rem; /* Espaçamento do conteúdo acima */
            flex-grow: 1; /* Permite que ocupe o espaço restante */
            display: flex;
            flex-direction: column;
        }

        .country-details-panel .news-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .country-details-panel .news-title {
            color: var(--news-red);
            margin: 0;
            font-size: 1.4rem;
        }

        .country-details-panel .refresh-btn {
            background: rgba(255, 77, 77, 0.2);
            border: none;
            border-radius: 5px;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .country-details-panel .refresh-btn:hover {
            background: rgba(255, 77, 77, 0.3);
            transform: translateY(-2px);
        }

        .country-details-panel .news-content {
            flex-grow: 1;
            overflow-y: auto; /* Notícias roláveis dentro do painel */
        }

        .country-details-panel .news-item {
            margin-bottom: 1.2rem;
            padding-bottom: 1.2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .country-details-panel .news-item h3 {
            margin: 0 0 0.5rem 0;
            color: white;
            font-size: 1.1rem;
        }

        .country-details-panel .news-item p {
            margin: 0.3rem 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
        }

        .country-details-panel .news-source {
            font-size: 0.85rem;
            color: var(--news-red);
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
        }

        .loading {
            display: none; /* Controlado por JS */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
        }

        .loading.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(77, 237, 255, 0.2);
            border-top-color: var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            padding: 1rem;
        }

        .api-note {
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        /* Estilos para o LLM */
        .llm-feature {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1.2rem;
            border-left: 3px solid var(--neon-purple); /* Cor diferente para LLM */
            margin-top: 1.5rem; /* Espaçamento */
        }

        .llm-feature .info-title {
            color: var(--neon-purple);
        }

        .llm-output {
            margin-top: 1rem;
            padding: 0.8rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.9);
            min-height: 50px; /* Garante altura mínima */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .llm-output.loading-text {
            color: rgba(255, 255, 255, 0.6);
            font-style: normal;
        }

        .llm-button {
            background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue));
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.2rem;
            color: white;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            margin-top: 1rem;
            width: 100%; /* Ocupa a largura total */
        }

        .llm-button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(132, 90, 255, 0.3);
        }

        .llm-button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }


        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            /* Em telas menores, o map-container pode ter uma altura fixa para garantir visibilidade */
            .map-container {
                height: 500px; /* Altura fixa para telas menores */
                flex-grow: 0; /* Desabilita flex-grow quando a altura é fixa */
            }
            .country-details-panel { /* Ajuste para telas menores */
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                height: auto;
                opacity: 1;
                pointer-events: auto;
                margin-top: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="planet-decoration planet-1"></div>
            <div class="planet-decoration planet-2"></div>
            <h1><i class="fas fa-star"></i> CosmoNews - Mapa Estelar</h1>
            <p class="subtitle">Explore o universo, notícias em tempo real e o céu noturno</p>
            <div class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i> Modo Noturno
            </div>
        </header>

        <div class="main-content">
            <div class="map-section">
                <div class="controls">
                    <button class="control-btn" id="zoom-in"><i class="fas fa-search-plus"></i> Zoom In</button>
                    <button class="control-btn" id="zoom-out"><i class="fas fa-search-minus"></i> Zoom Out</button>
                    <button class="control-btn" id="reset-map"><i class="fas fa-globe-americas"></i> Resetar Mapa</button>
                    <button class="control-btn" id="rotate-map"><i class="fas fa-sync-alt"></i> Rotacionar</button>
                </div>
                
                <div class="map-container">
                    <div id="world-map"></div>
                    <div class="map-country-hover-info" id="map-country-hover-info">
                        <img id="map-hover-flag" src="" alt="Bandeira">
                        <span id="map-hover-name"></span>
                    </div>
                    <div class="loading" id="map-loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando mapa estelar...</p>
                    </div>
                </div>
                <div class="country-details-panel" id="country-details-panel">
                    <div class="flag-and-name">
                        <img id="details-flag" src="" alt="Bandeira do País">
                        <h3 id="details-country-name">Selecione um País</h3>
                    </div>
                    <p><span class="info-label">Capital:</span> <span id="details-capital">--</span></p>
                    <p><span class="info-label">População:</span> <span id="details-population">--</span></p>
                    <p><span class="info-label">Idioma:</span> <span id="details-language">--</span></p>
                    <p><span class="info-label">Moeda:</span> <span id="details-currency">--</span></p>
                    <p><span class="info-label">Coordenadas:</span> <span id="details-coords">--</span></p>
                    <p><span class="info-label">Fuso Horário:</span> <span id="details-timezone">--</span></p>

                    <div class="news-section">
                        <div class="news-header">
                            <h2 class="news-title"><i class="fas fa-newspaper"></i> Notícias em Tempo Real</h2>
                            <button class="refresh-btn" id="refresh-details-news">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                        <div class="news-content" id="details-news-content">
                            <p>Notícias do país aparecerão aqui.</p>
                        </div>
                        <button class="llm-button" id="summarize-news-btn" disabled>
                            <i class="fas fa-magic"></i> ✨ Resumir Notícias
                        </button>
                        <div class="llm-output" id="news-summary-output">
                            O resumo das notícias aparecerá aqui.
                        </div>
                    </div>
                    </div>
            </div>

            <div class="info-panel">
                <div class="stellar-clock">
                    <div class="stellar-date" id="current-date">2 de junho de 2025</div>
                    <div class="stellar-time" id="stellar-time">--:--:--</div>
                    <div id="location-info">Clique em um país no mapa para começar</div>
                </div>

                <div class="info-grid">
                    <div class="info-box">
                        <h3 class="info-title"><i class="fas fa-star"></i> Astronomia</h3>
                        <p><span class="info-label">Hora Sideral:</span> <span id="sidereal-time">--:--:--</span></p>
                        <p><span class="info-label">Constelação:</span> <span id="constellation">--</span></p>
                        <p><span class="info-label">Altitude Solar:</span> <span id="sun-altitude">--°</span></p>
                        <p><span class="info-label">Fase Lunar:</span> <span id="moon-phase">--</span></p>
                        <button class="llm-button" id="explore-constellation-btn" disabled>
                            <i class="fas fa-brain"></i> ✨ Explorar Constelação
                        </button>
                        <div class="llm-output" id="constellation-details">
                            Detalhes da constelação aparecerão aqui.
                        </div>
                    </div>

                    <div class="info-box">
                        <h3 class="info-title"><i class="fas fa-cloud-moon"></i> Planetas Visíveis</h3>
                        <ul class="planet-list" id="visible-planets">
                            <li>Carregando...</li>
                        </ul>
                    </div>

                    <div class="info-box">
                        <h3 class="info-title"><i class="fas fa-meteor"></i> Chuvas de Meteoros</h3>
                        <div id="meteor-showers">
                            <p>Nenhuma chuva de meteoros ativa</p>
                        </div>
                    </div>

                    <div class="info-box">
                        <h3 class="info-title"><i class="fas fa-info-circle"></i> Informações do País</h3>
                        <p><span class="info-label">Fuso Horário:</span> <span id="timezone">--</span></p>
                        <p><span class="info-label">População:</span> <span id="population">--</span></p>
                        <p><span class="info-label">Idioma:</span> <span id="language">--</span></p>
                        <p><span class="info-label">Moeda:</span> <span id="currency">--</span></p>
                    </div>
                </div>

                <div class="llm-feature">
                    <h3 class="info-title"><i class="fas fa-lightbulb"></i> Curiosidade Espacial do Dia</h3>
                    <div class="llm-output" id="space-fact-output">
                        Clique no botão para gerar uma curiosidade!
                    </div>
                    <button class="llm-button" id="generate-space-fact-btn">
                        <i class="fas fa-rocket"></i> ✨ Gerar Curiosidade
                    </button>
                </div>

                </div>
        </div>

        <footer>
            <p>CosmoNews © 2025 | Dados astronômicos por Astronomy Engine | Notícias por NewsAPI</p>
            <p class="api-note">Nota: Esta demonstração usa uma chave de API de teste. Para funcionar, você precisa de uma chave da NewsAPI e o aplicativo deve ser executado em 'localhost' ou em um plano pago da NewsAPI.</p>
        </footer>
    </div>

    <script>
        // Dados dos países
        const countriesData = {
            "BR": { 
                name: "Brasil", 
                capital: "Brasília", 
                lat: -15.78, 
                lon: -47.93, 
                timezone: "UTC-3",
                population: "214 milhões",
                language: "Português",
                currency: "Real (BRL)",
                constellations: ["Cruzeiro do Sul", "Escorpião", "Centauro"]
            },
            "US": { 
                name: "Estados Unidos", 
                capital: "Washington, D.C.", 
                lat: 38.90, 
                lon: -77.04, 
                timezone: "UTC-4 a UTC-10",
                population: "331 milhões",
                language: "Inglês",
                currency: "Dólar (USD)",
                constellations: ["Órion", "Ursa Maior", "Touro"]
            },
            "GB": { 
                name: "Reino Unido", 
                capital: "Londres", 
                lat: 51.50, 
                lon: -0.12, 
                timezone: "UTC+1",
                population: "67 milhões",
                language: "Inglês",
                currency: "Libra Esterlina (GBP)",
                constellations: ["Cassiopeia", "Ursa Menor", "Pégaso"]
            },
            "JP": {
                name: "Japão",
                capital: "Tóquio",
                lat: 35.68,
                lon: 139.69,
                timezone: "UTC+9",
                population: "125 milhões",
                language: "Japonês",
                currency: "Iene (JPY)",
                constellations: ["Ursa Maior", "Órion", "Touro"]
            },
            "AU": {
                name: "Austrália",
                capital: "Camberra",
                lat: -35.28,
                lon: 149.13,
                timezone: "UTC+10",
                population: "26 milhões",
                language: "Inglês",
                currency: "Dólar Australiano (AUD)",
                constellations: ["Cruzeiro do Sul", "Centauro", "Carina"]
            },
            "FR": {
                name: "França",
                capital: "Paris",
                lat: 48.85,
                lon: 2.35,
                timezone: "UTC+2",
                population: "65 milhões",
                language: "Francês",
                currency: "Euro (EUR)",
                constellations: ["Órion", "Ursa Maior", "Pégaso"]
            },
            "DE": {
                name: "Alemanha",
                capital: "Berlim",
                lat: 52.52,
                lon: 13.40,
                timezone: "UTC+2",
                population: "83 milhões",
                language: "Alemão",
                currency: "Euro (EUR)",
                constellations: ["Ursa Maior", "Cisne", "Lira"]
            },
            "IN": {
                name: "Índia",
                capital: "Nova Delhi",
                lat: 28.61,
                lon: 77.20,
                timezone: "UTC+5:30",
                population: "1.4 bilhão",
                language: "Hindi, Inglês",
                currency: "Rúpia Indiana (INR)",
                constellations: ["Órion", "Escorpião", "Ursa Maior"]
            },
            "CN": {
                name: "China",
                capital: "Pequim",
                lat: 39.90,
                lon: 116.39,
                timezone: "UTC+8",
                population: "1.4 bilhão",
                language: "Mandarim",
                currency: "Yuan (CNY)",
                constellations: ["Dragão", "Ursa Maior", "Cassiopeia"]
            },
            "RU": {
                name: "Rússia",
                capital: "Moscou",
                lat: 55.75,
                lon: 37.61,
                timezone: "UTC+2 a UTC+12",
                population: "146 milhões",
                language: "Russo",
                currency: "Rublo (RUB)",
                constellations: ["Ursa Maior", "Órion", "Cassiopeia"]
            },
             "CA": { 
                name: "Canadá", 
                capital: "Ottawa", 
                lat: 45.42, 
                lon: -75.69, 
                timezone: "UTC-3:30 a UTC-8",
                population: "38 milhões",
                language: "Inglês, Francês",
                currency: "Dólar Canadense (CAD)",
                constellations: ["Ursa Maior", "Cassiopeia", "Cisne"]
            },
            "MX": { 
                name: "México", 
                capital: "Cidade do México", 
                lat: 19.43, 
                lon: -99.13, 
                timezone: "UTC-5 a UTC-8",
                population: "128 milhões",
                language: "Espanhol",
                currency: "Peso Mexicano (MXN)",
                constellations: ["Órion", "Escorpião", "Cão Maior"]
            },
            "AR": { 
                name: "Argentina", 
                capital: "Buenos Aires", 
                lat: -34.60, 
                lon: -58.38, 
                timezone: "UTC-3",
                population: "45 milhões",
                language: "Espanhol",
                currency: "Peso Argentino (ARS)",
                constellations: ["Cruzeiro do Sul", "Centauro", "Órion"]
            },
            "ZA": { 
                name: "África do Sul", 
                capital: "Pretória", 
                lat: -25.74, 
                lon: 28.22, 
                timezone: "UTC+2",
                population: "59 milhões",
                language: "Zulu, Xhosa, Africâner, Inglês, etc.",
                currency: "Rand (ZAR)",
                constellations: ["Cruzeiro do Sul", "Centauro", "Carina"]
            },
            "EG": { 
                name: "Egito", 
                capital: "Cairo", 
                lat: 30.04, 
                lon: 31.23, 
                timezone: "UTC+2",
                population: "102 milhões",
                language: "Árabe",
                currency: "Libra Egípcia (EGP)",
                constellations: ["Órion", "Touro", "Cassiopeia"]
            },
            "NG": { 
                name: "Nigéria", 
                capital: "Abuja", 
                lat: 9.07, 
                lon: 7.49, 
                timezone: "UTC+1",
                population: "211 milhões",
                language: "Inglês",
                currency: "Naira (NGN)",
                constellations: ["Órion", "Cão Maior", "Leão"]
            },
            "KE": { 
                name: "Quênia", 
                capital: "Nairóbi", 
                lat: -1.29, 
                lon: 36.82, 
                timezone: "UTC+3",
                population: "53 milhões",
                language: "Suaíli, Inglês",
                currency: "Xelim Queniano (KES)",
                constellations: ["Órion", "Cão Maior", "Cruzeiro do Sul"]
            },
            "SA": { 
                name: "Arábia Saudita", 
                capital: "Riade", 
                lat: 24.71, 
                lon: 46.67, 
                timezone: "UTC+3",
                population: "35 milhões",
                language: "Árabe",
                currency: "Riyal Saudita (SAR)",
                constellations: ["Órion", "Touro", "Escorpião"]
            },
            "PK": { 
                name: "Paquistão", 
                capital: "Islamabade", 
                lat: 33.68, 
                lon: 73.04, 
                timezone: "UTC+5",
                population: "220 milhões",
                language: "Urdu, Inglês",
                currency: "Rupia Paquistanesa (PKR)",
                constellations: ["Ursa Maior", "Órion", "Touro"]
            },
            "ID": { 
                name: "Indonésia", 
                capital: "Jacarta", 
                lat: -6.20, 
                lon: 106.84, 
                timezone: "UTC+7 a UTC+9",
                population: "276 milhões",
                language: "Indonésio",
                currency: "Rupia Indonésia (IDR)",
                constellations: ["Cruzeiro do Sul", "Órion", "Escorpião"]
            },
            "NG": { 
                name: "Nigéria", 
                capital: "Abuja", 
                lat: 9.07, 
                lon: 7.49, 
                timezone: "UTC+1",
                population: "211 milhões",
                language: "Inglês",
                currency: "Naira Nigeriana (NGN)",
                constellations: ["Órion", "Cão Maior", "Leão"]
            },
            "SE": { 
                name: "Suécia", 
                capital: "Estocolmo", 
                lat: 59.32, 
                lon: 18.06, 
                timezone: "UTC+2",
                population: "10 milhões",
                language: "Sueco",
                currency: "Coroa Sueca (SEK)",
                constellations: ["Ursa Maior", "Cisne", "Lira"]
            },
            "NO": { 
                name: "Noruega", 
                capital: "Oslo", 
                lat: 59.91, 
                lon: 10.75, 
                timezone: "UTC+2",
                population: "5 milhões",
                language: "Norueguês",
                currency: "Coroa Norueguesa (NOK)",
                constellations: ["Ursa Maior", "Cisne", "Cassiopeia"]
            },
            "DK": { 
                name: "Dinamarca", 
                capital: "Copenhague", 
                lat: 55.67, 
                lon: 12.56, 
                timezone: "UTC+2",
                population: "5.8 milhões",
                language: "Dinamarquês",
                currency: "Coroa Dinamarquesa (DKK)",
                constellations: ["Ursa Maior", "Cisne", "Lira"]
            },
            "FI": { 
                name: "Finlândia", 
                capital: "Helsinque", 
                lat: 60.16, 
                lon: 24.93, 
                timezone: "UTC+3",
                population: "5.5 milhões",
                language: "Finlandês, Sueco",
                currency: "Euro (EUR)",
                constellations: ["Ursa Maior", "Cisne", "Cassiopeia"]
            },
            "IS": { 
                name: "Islândia", 
                capital: "Reykjavík", 
                lat: 64.96, 
                lon: -19.02, 
                timezone: "UTC+0",
                population: "370 mil",
                language: "Islandês",
                currency: "Coroa Islandesa (ISK)",
                constellations: ["Ursa Maior", "Ursa Menor", "Cisne"]
            },
            "NZ": { 
                name: "Nova Zelândia", 
                capital: "Wellington", 
                lat: -41.28, 
                lon: 174.77, 
                timezone: "UTC+12",
                population: "5 milhões",
                language: "Inglês, Maori",
                currency: "Dólar Neozelandês (NZD)",
                constellations: ["Cruzeiro do Sul", "Centauro", "Carina"]
            },
            "KR": { 
                name: "Coreia do Sul", 
                capital: "Seul", 
                lat: 37.56, 
                lon: 126.97, 
                timezone: "UTC+9",
                population: "51 milhões",
                language: "Coreano",
                currency: "Won Sul-Coreano (KRW)",
                constellations: ["Ursa Maior", "Órion", "Touro"]
            },
            "ES": { 
                name: "Espanha", 
                capital: "Madri", 
                lat: 40.41, 
                lon: -3.70, 
                timezone: "UTC+2",
                population: "47 milhões",
                language: "Espanhol",
                currency: "Euro (EUR)",
                constellations: ["Órion", "Touro", "Escorpião"]
            },
            "IT": { 
                name: "Itália", 
                capital: "Roma", 
                lat: 41.90, 
                lon: 12.49, 
                timezone: "UTC+2",
                population: "59 milhões",
                language: "Italiano",
                currency: "Euro (EUR)",
                constellations: ["Órion", "Touro", "Leão"]
            },
            "GR": { 
                name: "Grécia", 
                capital: "Atenas", 
                lat: 37.98, 
                lon: 23.72, 
                timezone: "UTC+3",
                population: "10 milhões",
                language: "Grego",
                currency: "Euro (EUR)",
                constellations: ["Órion", "Lira", "Cisne"]
            },
            "TR": { 
                name: "Turquia", 
                capital: "Ancara", 
                lat: 39.93, 
                lon: 32.85, 
                timezone: "UTC+3",
                population: "84 milhões",
                language: "Turco",
                currency: "Lira Turca (TRY)",
                constellations: ["Órion", "Touro", "Escorpião"]
            }
        };

        const defaultCountryCode = "BR";
        const defaultCountryTopoId = "076"; // TopoJSON ID para Brasil

        let currentSelectedCountryCode = defaultCountryCode;
        let currentSelectedCountryData = countriesData[defaultCountryCode];

        // Variáveis globais para o mapa D3
        let svgMap;
        let projection;
        let pathGenerator;
        let zoomBehavior;
        let currentTransform = d3.zoomIdentity;
        let rotationInterval; // Para a rotação automática

        // Elementos do DOM
        const themeToggle = document.getElementById('theme-toggle');
        const stellarTimeElement = document.getElementById('stellar-time');
        const currentDateElement = document.getElementById('current-date');
        const locationInfoElement = document.getElementById('location-info');
        const siderealTimeElement = document.getElementById('sidereal-time');
        const constellationElement = document.getElementById('constellation');
        const sunAltitudeElement = document.getElementById('sun-altitude');
        const moonPhaseElement = document.getElementById('moon-phase');
        const visiblePlanetsElement = document.getElementById('visible-planets');
        const meteorShowersElement = document.getElementById('meteor-showers');

        // Detalhes do país no painel lateral
        const countryDetailsPanel = document.getElementById('country-details-panel');
        const detailsFlag = document.getElementById('details-flag');
        const detailsCountryName = document.getElementById('details-country-name');
        const detailsCapital = document.getElementById('details-capital');
        const detailsPopulation = document.getElementById('details-population');
        const detailsLanguage = document.getElementById('details-language');
        const detailsCurrency = document.getElementById('details-currency');
        const detailsCoords = document.getElementById('details-coords');
        const detailsTimezone = document.getElementById('details-timezone');
        const detailsNewsContent = document.getElementById('details-news-content');
        const refreshDetailsNewsBtn = document.getElementById('refresh-details-news');
        const summarizeNewsBtn = document.getElementById('summarize-news-btn');
        const newsSummaryOutput = document.getElementById('news-summary-output');

        // Botões de controle do mapa
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const resetMapBtn = document.getElementById('reset-map');
        const rotateMapBtn = document.getElementById('rotate-map');

        // Hover info do mapa
        const mapCountryHoverInfo = document.getElementById('map-country-hover-info');
        const mapHoverFlag = document.getElementById('map-hover-flag');
        const mapHoverName = document.getElementById('map-hover-name');
        let currentHoveredCountryD3Datum = null;


        // LLM Feature elements
        const generateSpaceFactBtn = document.getElementById('generate-space-fact-btn');
        const spaceFactOutput = document.getElementById('space-fact-output');
        const exploreConstellationBtn = document.getElementById('explore-constellation-btn');
        const constellationDetailsOutput = document.getElementById('constellation-details');

        // Chave da API NewsAPI (ATENÇÃO: Mantenha em ambiente de desenvolvimento ou use um proxy)
        const NEWS_API_KEY = 'YOUR_NEWS_API_KEY'; // **Substitua pela sua chave REAL da NewsAPI**

        // Cores para os planetas visíveis
        const planetColors = {
            "Mercúrio": "#A9A9A9", // Cinza escuro
            "Vênus": "#DAA520",    // Dourado
            "Marte": "#B22222",    // Vermelho tijolo
            "Júpiter": "#CD853F",  // Castanho claro
            "Saturno": "#D2B48C",  // Bege
            "Urano": "#87CEEB",    // Azul celeste
            "Netuno": "#4169E1"    // Azul royal
        };

        // --- Funções de Ajuda ---

        function formatTime(date) {
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' });
        }

        function getMoonPhase(jd) {
            const phase = Astronomy.MoonPhase(jd);
            if (phase < 0.05 || phase > 0.95) return "Lua Nova";
            if (phase < 0.20) return "Crescente Riscada";
            if (phase < 0.30) return "Quarto Crescente";
            if (phase < 0.45) return "Gibosa Crescente";
            if (phase < 0.55) return "Lua Cheia";
            if (phase < 0.70) return "Gibosa Minguante";
            if (phase < 0.80) return "Quarto Minguante";
            return "Minguante Riscada";
        }

        async function fetchNews(query) {
            if (NEWS_API_KEY === 'YOUR_NEWS_API_KEY') {
                console.warn("NewsAPI Key não configurada. Por favor, substitua 'YOUR_NEWS_API_KEY' pela sua chave real.");
                return [];
            }
            try {
                // Para usar a NewsAPI em produção, você precisará de um plano pago ou rodar em localhost.
                // Esta URL busca as 5 principais notícias em português para o país.
                const url = `https://newsapi.org/v2/top-headlines?q=${query}&language=pt&pageSize=5&apiKey=${NEWS_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === "ok") {
                    return data.articles;
                } else {
                    console.error("Erro na NewsAPI:", data.message);
                    return [];
                }
            } catch (error) {
                console.error("Erro ao buscar notícias:", error);
                return [];
            }
        }

        // --- Funções de Atualização da UI ---

        function updateDateTime() {
            const now = new Date();
            currentDateElement.textContent = formatDate(now);
            stellarTimeElement.textContent = formatTime(now);
        }

        function updateAstronomyInfo(lat, lon) {
            const now = new Date();
            const jd = Astronomy.Make=from=UTC(now.getFullYear(), now.getMonth() + 1, now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());
            const geo = new Astronomy.L=ocation(lat, lon, 0); // Altitude 0 por padrão

            const lst = Astronomy.SiderealTime(jd, lon);
            siderealTimeElement.textContent = Astronomy.Hour=Angle.To=String(lst);

            const sun = Astronomy.Sun=Position(jd);
            const sunHor = Astronomy.Equatorial=To=Horizontal(sun.ra, sun.dec, geo, jd);
            sunAltitudeElement.textContent = sunHor.alt.toFixed(2) + "°";

            moonPhaseElement.textContent = getMoonPhase(jd);

            // Planetas visíveis
            const planets = ["Mercúrio", "Vênus", "Marte", "Júpiter", "Saturno", "Urano", "Netuno"];
            visiblePlanetsElement.innerHTML = '';
            let anyVisible = false;

            planets.forEach(planetName => {
                try {
                    const body = Astronomy[planetName];
                    const pos = Astronomy.Equatorial(body, jd);
                    const hor = Astronomy.Equatorial=To=Horizontal(pos.ra, pos.dec, geo, jd);

                    // Considerar visível se acima de 0 graus de altitude e dia/noite adequado
                    // Simplificado: apenas acima do horizonte
                    if (hor.alt > 0) { 
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="planet-icon" style="background-color: ${planetColors[planetName]}"></span> ${planetName} (${hor.alt.toFixed(1)}°)`;
                        visiblePlanetsElement.appendChild(li);
                        anyVisible = true;
                    }
                } catch (e) {
                    console.error(`Erro ao calcular posição de ${planetName}:`, e);
                }
            });

            if (!anyVisible) {
                visiblePlanetsElement.innerHTML = '<li>Nenhum planeta visível no momento (acima do horizonte).</li>';
            }

            // Chuvas de Meteoros (dados estáticos de exemplo)
            const meteorShowers = [
                { name: "Lirídeos", active: (now.getMonth() === 3 && now.getDate() >= 16 && now.getDate() <= 25), peak: "22 de Abr" },
                { name: "Perseidas", active: (now.getMonth() === 7 && now.getDate() >= 17 && now.getDate() <= 24), peak: "12 de Ago" },
                { name: "Gemínidas", active: (now.getMonth() === 11 && now.getDate() >= 4 && now.getDate() <= 17), peak: "14 de Dez" }
            ];

            meteorShowersElement.innerHTML = '';
            let anyShowerActive = false;
            meteorShowers.forEach(shower => {
                if (shower.active) {
                    meteorShowersElement.innerHTML += `<p>${shower.name} (Pico: ${shower.peak})</p>`;
                    anyShowerActive = true;
                }
            });
            if (!anyShowerActive) {
                meteorShowersElement.innerHTML = '<p>Nenhuma chuva de meteoros ativa.</p>';
            }
        }

        async function updateCountryDetailsPanel(countryData) {
            detailsFlag.src = `https://flagcdn.com/w320/${countryData.countryCode.toLowerCase()}.png`;
            detailsCountryName.textContent = countryData.name;
            detailsCapital.textContent = countryData.capital;
            detailsPopulation.textContent = countryData.population;
            detailsLanguage.textContent = countryData.language;
            detailsCurrency.textContent = countryData.currency;
            detailsCoords.textContent = `${countryData.lat.toFixed(2)}°, ${countryData.lon.toFixed(2)}°`;
            detailsTimezone.textContent = countryData.timezone;

            locationInfoElement.textContent = `Você está vendo dados para: ${countryData.name}`;

            // Resetar LLM outputs
            newsSummaryOutput.textContent = 'O resumo das notícias aparecerá aqui.';
            constellationDetailsOutput.textContent = 'Detalhes da constelação aparecerão aqui.';
            summarizeNewsBtn.disabled = true;
            exploreConstellationBtn.disabled = false; // Habilita o botão de explorar constelação

            await loadNewsForCountry(countryData.name);
            countryDetailsPanel.classList.add('show');
        }

        async function loadNewsForCountry(countryName) {
            detailsNewsContent.innerHTML = '<p class="loading-text">Carregando notícias...</p>';
            summarizeNewsBtn.disabled = true;
            newsSummaryOutput.textContent = 'O resumo das notícias aparecerá aqui.';

            const articles = await fetchNews(countryName); // Buscar notícias pelo nome do país
            detailsNewsContent.innerHTML = '';

            if (articles.length > 0) {
                articles.forEach(article => {
                    const newsItem = document.createElement('div');
                    newsItem.classList.add('news-item');
                    newsItem.innerHTML = `
                        <h3><a href="${article.url}" target="_blank" style="color: inherit; text-decoration: none;">${article.title || 'Sem título'}</a></h3>
                        <p>${article.description || 'Sem descrição.'}</p>
                        <div class="news-source">
                            <span>${article.source.name || 'Fonte Desconhecida'}</span>
                            <span>${article.publishedAt ? new Date(article.publishedAt).toLocaleDateString('pt-BR') : ''}</span>
                        </div>
                    `;
                    detailsNewsContent.appendChild(newsItem);
                });
                summarizeNewsBtn.disabled = false; // Habilita botão de resumo se houver notícias
            } else {
                detailsNewsContent.innerHTML = '<p>Nenhuma notícia encontrada para este país.</p>';
                summarizeNewsBtn.disabled = true;
            }
        }

        // --- Funções do Mapa D3 ---

        async function renderMap() {
            const mapLoading = document.getElementById('map-loading');
            mapLoading.classList.add('show');

            const mapContainer = document.getElementById('world-map');
            const width = mapContainer.offsetWidth;
            const height = mapContainer.offsetHeight;

            if (width === 0 || height === 0) {
                console.warn("Contêiner do mapa tem dimensões zero. Atrasando renderização.");
                mapLoading.classList.remove('show');
                return;
            }

            // Remover SVG existente e limpar eventos para evitar duplicação e memory leaks
            d3.select("#world-map svg").remove();
            if (svgMap) { // Limpa eventos do SVG anterior
                svgMap.on(".zoom", null);
                svgMap.on(".drag", null); // O zoom behavior também gerencia o drag
            }

            svgMap = d3.select("#world-map")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", `0 0 ${width} ${height}`);

            // Projeção e path generator
            projection = d3.geoMercator()
                .scale(width / 2 / Math.PI)
                .translate([width / 2, height / 1.5]); // Ajuste para centralizar verticalmente

            pathGenerator = d3.geoPath().projection(projection);

            // Zoom behavior
            zoomBehavior = d3.zoom()
                .scaleExtent([0.5, 8]) // Limites de zoom
                .on("zoom", (event) => {
                    currentTransform = event.transform;
                    svgMap.selectAll("path").attr("transform", event.transform);
                    // Oculta a caixa de hover durante o zoom/pan
                    mapCountryHoverInfo.classList.remove('show');
                });

            svgMap.call(zoomBehavior);

            // Desabilitar duplo clique para zoom padrão para evitar comportamento inesperado
            svgMap.on("dblclick.zoom", null); 

            // Adiciona classes para cursor de arrastar
            svgMap.on("mousedown", function() {
                d3.select(this.parentNode).classed("grabbing", true);
            })
            .on("mouseup", function() {
                d3.select(this.parentNode).classed("grabbing", false);
            });

            // CORREÇÃO: Usar URL válida para o World Atlas
            try {
                const world = await d3.json("https://unpkg.com/world-atlas@2.0.2/countries-110m.json");
                const countries = topojson.feature(world, world.objects.countries);

                svgMap.append("g")
                    .attr("class", "countries")
                    .selectAll("path")
                    .data(countries.features)
                    .enter().append("path")
                    .attr("class", "country")
                    .attr("d", pathGenerator)
                    .attr("fill", "rgba(77, 237, 255, 0.1)") // Cor padrão dos países
                    .attr("stroke", "rgba(77, 237, 255, 0.3)")
                    .attr("stroke-width", 0.5)
                    .attr("id", d => `country-${d.id}`) // Adiciona ID para seleção fácil
                    .on("click", function(event, d) {
                        const countryCode = Object.keys(countriesData).find(key => countriesData[key].name === d.properties.name);
                        if (countryCode) {
                            currentSelectedCountryCode = countryCode;
                            currentSelectedCountryData = countriesData[countryCode];
                            // Remove a seleção de outros países
                            svgMap.selectAll(".country").classed("selected", false);
                            d3.select(this).classed("selected", true);
                            updateCountryDetailsPanel(currentSelectedCountryData);
                            updateAstronomyInfo(currentSelectedCountryData.lat, currentSelectedCountryData.lon);
                            zoomToCountry(d); // Zoom no país clicado
                        } else {
                            console.warn(`Dados não encontrados para o país: ${d.properties.name}`);
                            countryDetailsPanel.classList.remove('show'); // Oculta painel se país não tiver dados
                            locationInfoElement.textContent = "País não disponível nos dados. Clique em outro.";
                            // Remove seleção
                            svgMap.selectAll(".country").classed("selected", false);
                        }
                        mapCountryHoverInfo.classList.remove('show'); // Oculta hover ao clicar
                    })
                    .on("mouseover", function(event, d) {
                        const countryCode = Object.keys(countriesData).find(key => countriesData[key].name === d.properties.name);
                        if (countryCode) {
                            currentHoveredCountryD3Datum = d; // Guarda o datum para o mousemove otimizado
                            mapHoverFlag.src = `https://flagcdn.com/w320/${countryCode.toLowerCase()}.png`;
                            mapHoverName.textContent = countriesData[countryCode].name;
                            mapCountryHoverInfo.classList.add('show');
                            // Adicionar classe para hover otimizado no CSS
                            d3.select(this).classed("hovered", true);
                        } else {
                            mapCountryHoverInfo.classList.remove('show');
                        }
                    })
                    .on("mouseout", function() {
                        mapCountryHoverInfo.classList.remove('show');
                        currentHoveredCountryD3Datum = null;
                        d3.select(this).classed("hovered", false); // Remove classe de hover
                    });

                // CORREÇÃO: Seleção inicial correta do Brasil
                const brazilPath = svgMap.select(`#country-${defaultCountryTopoId}`);
                if (!brazilPath.empty()) {
                    // Pequeno delay para garantir que o SVG foi totalmente renderizado antes de despachar o clique
                    setTimeout(() => brazilPath.dispatch("click"), 100);
                }

            } catch (error) {
                console.error("Erro ao carregar mapa:", error);
                mapLoading.innerHTML = `<p>Erro ao carregar mapa: ${error.message}</p>`;
            } finally {
                mapLoading.classList.remove('show');
            }
        }

        // CORREÇÃO: Otimização do ResizeObserver
        let lastWidth = 0, lastHeight = 0, resizeTimeout;
        const resizeObserver = new ResizeObserver(entries => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const mapContainer = document.getElementById('world-map');
                const newWidth = mapContainer.offsetWidth;
                const newHeight = mapContainer.offsetHeight;
                
                // Redesenha apenas se as dimensões mudaram significativamente
                if (Math.abs(newWidth - lastWidth) > 10 || 
                    Math.abs(newHeight - lastHeight) > 10) {
                    lastWidth = newWidth;
                    lastHeight = newHeight;
                    renderMap();
                }
            }, 300); // Debounce de 300ms
        });

        // Observa o contêiner do mapa
        resizeObserver.observe(document.getElementById('world-map'));


        // CORREÇÃO: Otimização de movimento do mouse com requestAnimationFrame
        let lastAnimationFrame;
        document.addEventListener('mousemove', (e) => {
            if (!mapCountryHoverInfo.classList.contains('show') || 
                !currentHoveredCountryD3Datum) return;

            if (lastAnimationFrame) cancelAnimationFrame(lastAnimationFrame);
            
            lastAnimationFrame = requestAnimationFrame(() => {
                // Obtenha a posição do mouse em relação ao viewport
                const mouseX = e.clientX;
                const mouseY = e.clientY;

                // Ajuste a posição da caixa de informações com base na posição do mouse
                // Offset de 20px para não ficar exatamente em cima do cursor
                mapCountryHoverInfo.style.left = `${mouseX + 20}px`;
                // Centraliza verticalmente a caixa de informações em relação ao cursor
                mapCountryHoverInfo.style.top = `${mouseY - mapCountryHoverInfo.offsetHeight / 2}px`;
            });
        });

        // Função para zoom no país
        function zoomToCountry(d) {
            const [[x0, y0], [x1, y1]] = pathGenerator.bounds(d);
            const width = svgMap.attr("width");
            const height = svgMap.attr("height");
            const scale = 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height);
            const translate = [
                (width - scale * (x0 + x1)) / 2,
                (height - scale * (y0 + y1)) / 2
            ];
            
            svgMap.transition().duration(750).call(
                zoomBehavior.transform,
                d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale)
            );
        }

        function resetMap() {
            svgMap.transition().duration(750).call(
                zoomBehavior.transform,
                d3.zoomIdentity // Reseta para a transformação de identidade (zoom padrão)
            );
            svgMap.selectAll(".country").classed("selected", false); // Remove seleção
            countryDetailsPanel.classList.remove('show'); // Oculta painel
            locationInfoElement.textContent = "Clique em um país no mapa para começar";
            // Redefine para o Brasil como padrão no painel de info
            updateAstronomyInfo(countriesData[defaultCountryCode].lat, countriesData[defaultCountryCode].lon);
            document.getElementById('timezone').textContent = countriesData[defaultCountryCode].timezone;
            document.getElementById('population').textContent = countriesData[defaultCountryCode].population;
            document.getElementById('language').textContent = countriesData[defaultCountryCode].language;
            document.getElementById('currency').textContent = countriesData[defaultCountryCode].currency;
            exploreConstellationBtn.disabled = true; // Desabilita botão de constelação
            constellationDetailsOutput.textContent = 'Detalhes da constelação aparecerão aqui.';
        }

        function startRotation() {
            if (rotationInterval) clearInterval(rotationInterval);
            let currentRotation = 0;
            rotationInterval = setInterval(() => {
                currentRotation = (currentRotation + 0.5) % 360; // Rotaciona 0.5 graus a cada 50ms
                projection.rotate([currentRotation, 0]);
                svgMap.selectAll("path").attr("d", pathGenerator);
            }, 50);
            rotateMapBtn.textContent = 'Parar Rotação';
            rotateMapBtn.classList.add('active'); // Opcional: Adicionar classe para indicar que está ativo
        }

        function stopRotation() {
            clearInterval(rotationInterval);
            rotationInterval = null;
            rotateMapBtn.textContent = 'Rotacionar';
            rotateMapBtn.classList.remove('active');
        }

        // --- LLM Feature Implementations (simuladas) ---

        async function generateSpaceFact() {
            spaceFactOutput.classList.add('loading-text');
            spaceFactOutput.textContent = 'Gerando curiosidade...';
            generateSpaceFactBtn.disabled = true;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer YOUR_OPENAI_API_KEY` // **Substitua pela sua chave REAL da OpenAI**
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: "Gere uma curiosidade fascinante e concisa sobre o espaço ou astronomia. Max 30 palavras." }],
                        max_tokens: 50,
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    spaceFactOutput.textContent = data.choices[0].message.content.trim();
                } else {
                    spaceFactOutput.textContent = "Não foi possível gerar a curiosidade. Tente novamente.";
                }
            } catch (error) {
                console.error("Erro ao gerar curiosidade espacial:", error);
                spaceFactOutput.textContent = "Erro ao gerar curiosidade. Verifique sua chave da API.";
            } finally {
                spaceFactOutput.classList.remove('loading-text');
                generateSpaceFactBtn.disabled = false;
            }
        }

        async function summarizeNews() {
            newsSummaryOutput.classList.add('loading-text');
            newsSummaryOutput.textContent = 'Resumindo notícias...';
            summarizeNewsBtn.disabled = true;

            const newsArticles = Array.from(detailsNewsContent.querySelectorAll('.news-item h3 a'))
                                        .map(a => a.textContent)
                                        .join('\n');
            
            if (newsArticles.length === 0) {
                newsSummaryOutput.textContent = 'Não há notícias para resumir.';
                newsSummaryOutput.classList.remove('loading-text');
                summarizeNewsBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer YOUR_OPENAI_API_KEY` // **Substitua pela sua chave REAL da OpenAI**
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: `Resuma as seguintes notícias em português, de forma concisa e com 2-3 frases: \n\n${newsArticles}` }],
                        max_tokens: 150,
                        temperature: 0.5
                    })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    newsSummaryOutput.textContent = data.choices[0].message.content.trim();
                } else {
                    newsSummaryOutput.textContent = "Não foi possível gerar o resumo. Tente novamente.";
                }
            } catch (error) {
                console.error("Erro ao resumir notícias:", error);
                newsSummaryOutput.textContent = "Erro ao resumir notícias. Verifique sua chave da API.";
            } finally {
                newsSummaryOutput.classList.remove('loading-text');
                summarizeNewsBtn.disabled = false;
            }
        }

        async function exploreConstellation() {
            constellationDetailsOutput.classList.add('loading-text');
            constellationDetailsOutput.textContent = 'Explorando constelação...';
            exploreConstellationBtn.disabled = true;

            const currentConstellation = constellationElement.textContent;
            if (currentConstellation === "--") {
                constellationDetailsOutput.textContent = "Selecione um país no mapa para ver a constelação atual.";
                constellationDetailsOutput.classList.remove('loading-text');
                exploreConstellationBtn.disabled = false;
                return;
            }

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer YOUR_OPENAI_API_KEY` // **Substitua pela sua chave REAL da OpenAI**
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: `Descreva a constelação '${currentConstellation}' de forma interessante, incluindo sua história ou principais características. Max 80 palavras.` }],
                        max_tokens: 200,
                        temperature: 0.7
                    })
                });
                const data = await response.json();
                if (data.choices && data.choices.length > 0) {
                    constellationDetailsOutput.textContent = data.choices[0].message.content.trim();
                } else {
                    constellationDetailsOutput.textContent = "Não foi possível obter detalhes da constelação. Tente novamente.";
                }
            } catch (error) {
                console.error("Erro ao explorar constelação:", error);
                constellationDetailsOutput.textContent = "Erro ao explorar constelação. Verifique sua chave da API.";
            } finally {
                constellationDetailsOutput.classList.remove('loading-text');
                exploreConstellationBtn.disabled = false;
            }
        }


        // --- Event Listeners ---

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('day-mode');
            const isDayMode = document.body.classList.contains('day-mode');
            themeToggle.innerHTML = isDayMode ? '<i class="fas fa-sun"></i> Modo Diurno' : '<i class="fas fa-moon"></i> Modo Noturno';
        });

        zoomInBtn.addEventListener('click', () => {
            svgMap.transition().duration(200).call(zoomBehavior.scaleBy, 1.2);
        });

        zoomOutBtn.addEventListener('click', () => {
            svgMap.transition().duration(200).call(zoomBehavior.scaleBy, 0.8);
        });

        resetMapBtn.addEventListener('click', resetMap);

        rotateMapBtn.addEventListener('click', () => {
            if (rotationInterval) {
                stopRotation();
            } else {
                startRotation();
            }
        });

        refreshDetailsNewsBtn.addEventListener('click', () => {
            if (currentSelectedCountryData) {
                loadNewsForCountry(currentSelectedCountryData.name);
            }
        });

        generateSpaceFactBtn.addEventListener('click', generateSpaceFact);
        summarizeNewsBtn.addEventListener('click', summarizeNews);
        exploreConstellationBtn.addEventListener('click', exploreConstellation);


        // --- Inicialização ---

        document.addEventListener('DOMContentLoaded', () => {
            updateDateTime();
            setInterval(updateDateTime, 1000); // Atualiza a cada segundo
            
            // Inicia o mapa
            renderMap(); 

            // Define as informações iniciais para o Brasil no painel da direita
            const brazilData = countriesData[defaultCountryCode];
            document.getElementById('timezone').textContent = brazilData.timezone;
            document.getElementById('population').textContent = brazilData.population;
            document.getElementById('language').textContent = brazilData.language;
            document.getElementById('currency').textContent = brazilData.currency;
            updateAstronomyInfo(brazilData.lat, brazilData.lon);
            
            // Define a constelação inicial como uma das do Brasil
            constellationElement.textContent = brazilData.constellations[0] || "--";
        });
    </script>
</body>
</html>
